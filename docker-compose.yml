services:
  api:
    build:
      context: ./backend
    command: uvicorn app.main:app --host 0.0.0.0 --port ${API_INTERNAL_PORT:-8000} --reload
    environment:
      APP_NAME: Celery Media Processing Platform
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:postgres@postgres:5432/media_platform}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173}
      MEDIA_ROOT: ${MEDIA_ROOT:-/tmp/media}
      MAX_ACTIVE_TASKS_PER_USER: ${MAX_ACTIVE_TASKS_PER_USER:-3}
      CLEANUP_MAX_AGE_HOURS: ${CLEANUP_MAX_AGE_HOURS:-72}
      S3_ENABLED: ${S3_ENABLED:-false}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-media}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL:-http://localhost:9000}
    volumes:
      - ./backend/app:/app/app
      - media_data:/tmp/media
    ports:
      - "${API_PORT:-8000}:${API_INTERNAL_PORT:-8000}"
    depends_on:
      - postgres
      - redis

  worker:
    build:
      context: ./backend
    command: celery -A app.celery_app:celery_app worker --loglevel=info
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:postgres@postgres:5432/media_platform}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      MEDIA_ROOT: ${MEDIA_ROOT:-/tmp/media}
      S3_ENABLED: ${S3_ENABLED:-false}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-media}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL:-http://localhost:9000}
      CLEANUP_MAX_AGE_HOURS: ${CLEANUP_MAX_AGE_HOURS:-72}
    volumes:
      - ./backend/app:/app/app
      - media_data:/tmp/media
    depends_on:
      - api
      - redis
      - postgres
      - minio

  beat:
    build:
      context: ./backend
    command: celery -A app.celery_app:celery_app beat --loglevel=info
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:postgres@postgres:5432/media_platform}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      MEDIA_ROOT: ${MEDIA_ROOT:-/tmp/media}
      CLEANUP_MAX_AGE_HOURS: ${CLEANUP_MAX_AGE_HOURS:-72}
    volumes:
      - ./backend/app:/app/app
      - media_data:/tmp/media
    depends_on:
      - redis
      - postgres

  flower:
    build:
      context: ./backend
    command: celery -A app.celery_app:celery_app flower --port=${FLOWER_INTERNAL_PORT:-5555}
    environment:
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
    ports:
      - "${FLOWER_PORT:-5555}:${FLOWER_INTERNAL_PORT:-5555}"
    depends_on:
      - redis

  frontend:
    build:
      context: ./frontend
    command: sh -c "npm run dev -- --host 0.0.0.0 --port ${FRONTEND_INTERNAL_PORT:-5173}"
    ports:
      - "${FRONTEND_PORT:-5173}:${FRONTEND_INTERNAL_PORT:-5173}"
    environment:
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-}
      VITE_API_PORT: ${API_PORT:-8000}
    volumes:
      - ./frontend:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - api

  redis:
    image: redis:7.4-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"

  postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-media_platform}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"

  minio:
    image: minio/minio:RELEASE.2025-07-23T15-54-02Z
    command: server /data --console-address ":${MINIO_CONSOLE_INTERNAL_PORT:-9001}"
    profiles: ["s3"]
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:${MINIO_CONSOLE_INTERNAL_PORT:-9001}"

  minio-init:
    image: minio/mc:RELEASE.2025-07-21T05-28-08Z
    profiles: ["s3"]
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set local ${S3_ENDPOINT_URL:-http://minio:9000} ${S3_ACCESS_KEY:-minioadmin} ${S3_SECRET_KEY:-minioadmin};
      /usr/bin/mc mb -p local/${S3_BUCKET:-media};
      /usr/bin/mc anonymous set download local/${S3_BUCKET:-media};
      exit 0;
      "

volumes:
  postgres_data:
  media_data:
  minio_data:
